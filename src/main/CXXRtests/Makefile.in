# Low-level tests for the CXXR classes.

top_builddir = ../../..

top_srcdir = ../../..

include $(top_builddir)/Makeconf

maindir = ..

#ALL_CPPFLAGS = $(CPPFLAGS) -I../../include

sources_cxx = Allocatortest.cpp CellPooltest.cpp GCManagertest.cpp Heaptest.cpp

depends = $(sources_cxx:.cpp=.d)

tests = CellPooltest Heaptest Allocatortest GCManagertest

check : $(tests:=.ts)

Allocatortest.o : Allocatortest.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DVALGRIND_LEVEL=2 -DR_MEMORY_PROFILING -c -o $@ $<

Allocatortest_objs = Allocatortest.o Heap.o CellPool.o

Allocatortest : $(Allocatortest_objs)
	$(LINK.cc) -o $@ $(Allocatortest_objs)

Allocatortest.ts : Allocatortest Allocatortest.save
	valgrind -q --leak-check="yes" ./$< 10 12 > Allocatortest.out
	diff Allocatortest.save Allocatortest.out
	rm Allocatortest.out
	touch $@

CellPool.o : $(maindir)/CellPool.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DVALGRIND_LEVEL=2 -c -o $@ $<

CellPooltest.o : CellPooltest.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DVALGRIND_LEVEL=2 -c -o $@ $<

CellPooltest_objs = CellPooltest.o CellPool.o

CellPooltest : $(CellPooltest_objs)
	$(LINK.cc) -o $@ $(CellPooltest_objs)

CellPooltest.ts : CellPooltest CellPooltest.save
	valgrind -q --leak-check="yes" ./$< > CellPooltest.out
	diff CellPooltest.save CellPooltest.out
	rm CellPooltest.out
	touch $@

GCManager.o : $(maindir)/GCManager.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DDEBUG_ADJUST_HEAP -c -o $@ $<

GCManagertest_objs = GCManagertest.o GCManager.o Heap.o CellPool.o

GCManagertest : $(GCManagertest_objs)
	$(LINK.cc) -o $@ $(GCManagertest_objs)

GCManagertest.ts : GCManagertest GCManagertest.save
	./$< > GCManagertest.out
	grep -v '^#' GCManagertest.save | diff - GCManagertest.out
	rm GCManagertest.out
	touch $@

Heap.o : $(maindir)/Heap.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DVALGRIND_LEVEL=2 -DR_MEMORY_PROFILING -c -o $@ $<

Heaptest.o : Heaptest.cpp
	$(CXX) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -DVALGRIND_LEVEL=2 -DR_MEMORY_PROFILING -c -o $@ $<

Heaptest_objs = Heaptest.o Heap.o CellPool.o

Heaptest : $(Heaptest_objs)
	$(LINK.cc) -o $@ $(Heaptest_objs)

Heaptest.ts : Heaptest Heaptest.save
	valgrind -q --leak-check="yes" ./$< 10 12 > Heaptest.out
	diff Heaptest.save Heaptest.out
	rm Heaptest.out
	touch $@

RObject_sizer : RObject_sizer.o
	$(LINK.cc) -o $@ $<

Makefile : Makefile.in
	cp $< $@

include $(depends)
